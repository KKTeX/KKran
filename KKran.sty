\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{KKran}[2025/11/23, Version 1.0.0]
\RequirePackage{calc}
\RequirePackage{tikz}
\RequirePackage{KKsymbols}
\usetikzlibrary{shapes}
\usetikzlibrary{calc}

\def\kaitouhyouji@or@not@KKran{1}% opで切り替え可能にしとくこと
\NewDocumentCommand{\KaitouInput}{m}{%
  \ifnum\number\kaitouhyouji@or@not@KKran=1
    {\color{red}#1}%
    \ifnum\number\kaitouhyouji@or@not@KKran=0
      {\color{white}#1}%
    \fi%
  \fi%
}

\newdimen\width@KKran
\width@KKran=2\zw

\newdimen\waku@KKran \waku@KKran=.7pt
\newdimen\tensenwaku@KKran \tensenwaku@KKran =.35pt


\def\modai@bangou@wd{0.5}
\def\mondai@position@tmp{0}
\def\mondai@position@y@tmp{0}

\def\mondai@dash@pat@on{.5pt}
\def\mondai@dash@pat@off{.7pt}

\newcount\NUM@mondai
\newcount\NUM@shoumon

\NewDocumentCommand{\Daimon@Box@A@N}{ O{.5} m }{% 大問番号
  \global\advance\NUM@mondai by 1%
  \global\def\modai@bangou@wd{#1}%
  \draw[line width=\waku@KKran] (0,0) rectangle (#1\width@KKran,- #2\width@KKran);%
  \node[anchor=center,overlay
  % ,rotate=90 % 縦書きなら
  ]
   at (.5*#1\width@KKran,- .5*#2\width@KKran) {\scalebox{.8}{\kakko{\number\NUM@mondai}}};
  \pgfmathparse{\mondai@position@tmp + \modai@bangou@wd}%
  \edef\mondai@position@tmp{\pgfmathresult}%
}

\NewDocumentCommand{\Shoumon@Box@A@N}{ O{.5} m }{% 小問番号
  \advance\NUM@shoumon by 1%
  \draw[line width=\waku@KKran] (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran) -- ++ (0,- #2\width@KKran);
  \draw[line width=\waku@KKran] (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran) -- ++ (#1\width@KKran,0);
  \draw[line width=\tensenwaku@KKran, dash pattern=on \mondai@dash@pat@on off \mondai@dash@pat@off] (\mondai@position@tmp\width@KKran+#1\width@KKran,-\mondai@position@y@tmp\width@KKran) -- ++ (0,- #2\width@KKran);
  \draw[line width=\waku@KKran] (\mondai@position@tmp\width@KKran+#1\width@KKran,-\mondai@position@y@tmp\width@KKran- #2\width@KKran) -- ++ (-#1\width@KKran,0);
  \node[anchor=center,overlay] at (\mondai@position@tmp\width@KKran+.5*#1\width@KKran,-\mondai@position@y@tmp\width@KKran- .5*#2\width@KKran) {\scalebox{.8}{\kakko{\number\NUM@shoumon}}};
  \pgfmathparse{\mondai@position@tmp + #1}%
  \edef\mondai@position@tmp{\pgfmathresult}%
}


% 引数の修正がまだ！
\define@key{Shoumon@Box@A}{west}{%
  \def\westtext@Shoumon@Box@A{#1}%
}
\define@key{Shoumon@Box@A}{center}{%
  \def\centertext@Shoumon@Box@A{#1}%
}
\define@key{Shoumon@Box@A}{east}{%
  \def\easttext@Shoumon@Box@A{#1}%
}
\define@key{Shoumon@Box@A}{north west}{%
  \def\nwtext@Shoumon@Box@A{#1}%
}
\define@key{Shoumon@Box@A}{north east}{%
  \def\netext@Shoumon@Box@A{#1}%
}
\define@key{Shoumon@Box@A}{south west}{%
  \def\swtext@Shoumon@Box@A{#1}%
}
\define@key{Shoumon@Box@A}{south east}{%
  \def\setext@Shoumon@Box@A{#1}%
}
\NewDocumentCommand{\reset@Shoumon@Box@A}{}{%
  \def\westtext@Shoumon@Box@A{}%
  \def\centertext@Shoumon@Box@A{}%
  \def\easttext@Shoumon@Box@A{}%
  \def\nwtext@Shoumon@Box@A{}%
  \def\netext@Shoumon@Box@A{}%
  \def\swtext@Shoumon@Box@A{}%
  \def\setext@Shoumon@Box@A{}%
}
\NewDocumentCommand{\Shoumon@Box@A}{ O{.7pt} O{.35pt} m m O{} }{% 小問
  \reset@Shoumon@Box@A\setkeys{Shoumon@Box@A}{#5}%

  % 左上から反時計回りに A, B, C, D を定義
  \path (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran) coordinate (A@Shoumon@Box@A)
        -- ++(0,-#4\width@KKran) coordinate (B@Shoumon@Box@A)
        -- ++(#3\width@KKran,0)  coordinate (C@Shoumon@Box@A)
        -- ++(0,#4\width@KKran)  coordinate (D@Shoumon@Box@A);

  % 箱の描画
  \draw[line width=#2, dash pattern=on \mondai@dash@pat@on off \mondai@dash@pat@off] (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran) -- ++ (0,- #4\width@KKran);
  \draw[line width=#1] (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran) -- ++ (#3\width@KKran,0) -- ++ (0,- #4\width@KKran) -- ++ (-#3\width@KKran,0);

  % 文字列などの挿入用
  \node[overlay,anchor=center] at ($(A@Shoumon@Box@A)!0.5!(C@Shoumon@Box@A)$) {\centertext@Shoumon@Box@A};
  \node[overlay,anchor=west] at ($(A@Shoumon@Box@A)!0.5!(B@Shoumon@Box@A)$) {\westtext@Shoumon@Box@A};
  \node[overlay,anchor=east] at ($(C@Shoumon@Box@A)!0.5!(D@Shoumon@Box@A)$) {\easttext@Shoumon@Box@A};
  \node[overlay,anchor=north west] at (A@Shoumon@Box@A) {\nwtext@Shoumon@Box@A};
  \node[overlay,anchor=north east] at (D@Shoumon@Box@A) {\netext@Shoumon@Box@A};
  \node[overlay,anchor=south west] at (B@Shoumon@Box@A) {\swtext@Shoumon@Box@A};
  \node[overlay,anchor=south east] at (C@Shoumon@Box@A) {\setext@Shoumon@Box@A};

  % 座標の更新
  \pgfmathparse{\mondai@position@tmp + #3}%
  \edef\mondai@position@tmp{\pgfmathresult}%
}


\NewDocumentCommand{\Shoumon@Box@B}{ O{.7pt} O{.35pt} m m }{% 小問（右が点線に）
  \draw[line width=#2, dash pattern=on \mondai@dash@pat@on off \mondai@dash@pat@off] (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran) -- ++ (0,- #4\width@KKran);
  \draw[line width=#1] (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran) -- ++ (#3\width@KKran,0);
  \draw[line width=#2, dash pattern=on \mondai@dash@pat@on off \mondai@dash@pat@off] (\mondai@position@tmp\width@KKran+#3\width@KKran,-\mondai@position@y@tmp\width@KKran) -- ++ (0,- #4\width@KKran);
  \draw[line width=#1] (\mondai@position@tmp\width@KKran+#3\width@KKran,-\mondai@position@y@tmp\width@KKran- #4\width@KKran) -- ++ (-#3\width@KKran,0);
  \pgfmathparse{\mondai@position@tmp + #3}%
  \edef\mondai@position@tmp{\pgfmathresult}%
}


\newdimen\unit@KKran
\unit@KKran=2\zw
\NewDocumentCommand{\Shoumon@Grid@A}{ O{.7pt} O{.35pt} m O{#3}}{% 第３引数はmax、第４引数はmin
    \def\grid@max@A{#3}\def\grid@min@A{#4}%
    \ifnum\grid@max@A<\grid@min@A% 大小がおかしい時はerror
      \errmessage{Error: \grid@max@A (\the\grid@max@A) must be greater than or equal to \grid@min@A (\the\grid@min@A).}%
      \expandafter\endinput%
    \fi%
    \def\grid@x@A{20}% 可変にしてもいい
    \pgfmathtruncatemacro{\shou@grid@max@A}{\grid@max@A / \grid@x@A}%
    \pgfmathtruncatemacro{\amari@grid@max@A}{mod(\grid@max@A,\grid@x@A)}%
    \pgfmathtruncatemacro{\max@minus@amari@grid@max@A}{\grid@x@A-\amari@grid@max@A}%
    \pgfmathtruncatemacro{\shou@grid@min@A}{\grid@min@A / \grid@x@A}%
    \pgfmathtruncatemacro{\amari@grid@min@A}{mod(\grid@min@A,\grid@x@A)}%
    \pgfmathtruncatemacro{\min@minus@amari@grid@min@A}{\grid@x@A-\amari@grid@min@A}%

    \ifnum\grid@min@A<\grid@x@A% minの方の描画
      \draw[overlay,line width=#1] (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran-\unit@KKran) -- (\mondai@position@tmp\width@KKran+\amari@grid@min@A\unit@KKran,-\mondai@position@y@tmp\width@KKran-\unit@KKran);
      \draw[overlay,line width=#1] (\mondai@position@tmp\width@KKran+\amari@grid@min@A\unit@KKran,-\mondai@position@y@tmp\width@KKran-\unit@KKran) -- (\mondai@position@tmp\width@KKran+\amari@grid@min@A\unit@KKran,-\mondai@position@y@tmp\width@KKran+\shou@grid@min@A\unit@KKran);
      \draw[overlay,line width=#1] (\mondai@position@tmp\width@KKran+\amari@grid@min@A\unit@KKran,-\mondai@position@y@tmp\width@KKran+\shou@grid@min@A\unit@KKran) -- (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran);
    \else
      \ifnum\amari@grid@min@A=0% 余り0の方
        \draw[overlay,line width=#1] (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran-\shou@grid@min@A\unit@KKran) -- (\mondai@position@tmp\width@KKran+\grid@x@A\unit@KKran,-\mondai@position@y@tmp\width@KKran-\shou@grid@min@A\unit@KKran);
        \draw[overlay,line width=#1] (\mondai@position@tmp\width@KKran+\grid@x@A\unit@KKran,-\mondai@position@y@tmp\width@KKran-\shou@grid@min@A\unit@KKran) -- (\mondai@position@tmp\width@KKran+\grid@x@A\unit@KKran,-\mondai@position@y@tmp\width@KKran);
        \draw[overlay,line width=#1] (\mondai@position@tmp\width@KKran+\grid@x@A\unit@KKran,-\mondai@position@y@tmp\width@KKran) -- (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran);

      \else% 余り\neq0の方
        \coordinate (A@amari@non@zero) at (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran);%
        \coordinate (B@amari@non@zero) at (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran-\shou@grid@min@A\unit@KKran-\unit@KKran);%
        \coordinate (C@amari@non@zero) at (\mondai@position@tmp\width@KKran+\amari@grid@min@A\unit@KKran,-\mondai@position@y@tmp\width@KKran-\shou@grid@min@A\unit@KKran-\unit@KKran);%
        \coordinate (D@amari@non@zero) at (\mondai@position@tmp\width@KKran+\amari@grid@min@A\unit@KKran,-\mondai@position@y@tmp\width@KKran-\shou@grid@min@A\unit@KKran);%
        \coordinate (E@amari@non@zero) at (\mondai@position@tmp\width@KKran+\grid@x@A\unit@KKran,-\mondai@position@y@tmp\width@KKran-\shou@grid@min@A\unit@KKran);%
        \coordinate (F@amari@non@zero) at (\mondai@position@tmp\width@KKran+\grid@x@A\unit@KKran,-\mondai@position@y@tmp\width@KKran);%

        \draw[overlay,line width=#1] (B@amari@non@zero) -- (C@amari@non@zero);
        \draw[overlay,line width=#1] (C@amari@non@zero) -- (D@amari@non@zero);
        \draw[overlay,line width=#1] (D@amari@non@zero) -- (E@amari@non@zero);
        \draw[overlay,line width=#1] (E@amari@non@zero) -- (F@amari@non@zero);
        \draw[overlay,line width=#1] (F@amari@non@zero) -- (A@amari@non@zero);
      \fi
    \fi
    
    \ifnum\grid@max@A<\grid@x@A% maxの方の描画
      \draw[step=\unit@KKran,dashed,line width=#2] (\mondai@position@tmp\width@KKran+\unit@KKran,-\mondai@position@y@tmp\width@KKran-\unit@KKran) grid (\mondai@position@tmp\width@KKran+\amari@grid@max@A\unit@KKran,-\mondai@position@y@tmp\width@KKran+\shou@grid@max@A\unit@KKran);% まずはマス目

      \draw[line width=#2, dash pattern=on \mondai@dash@pat@on off \mondai@dash@pat@off]  (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran) -- (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran-\unit@KKran);
      \draw[line width=#1]
        (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran-\unit@KKran) -- % 1. 底辺の始点 (左下の角)
        (\mondai@position@tmp\width@KKran+\amari@grid@max@A\unit@KKran,-\mondai@position@y@tmp\width@KKran-\unit@KKran) -- % 2. 底辺の終点 (右下の角)
        (\mondai@position@tmp\width@KKran+\amari@grid@max@A\unit@KKran,-\mondai@position@y@tmp\width@KKran+\shou@grid@max@A\unit@KKran) -- % 3. 右の縦の辺 (右上の角)
        (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran+\shou@grid@max@A\unit@KKran); % 4. 上辺の終点 (左上の角)

      \pgfmathparse{\mondai@position@tmp + \grid@max@A}%
      \edef\mondai@position@tmp{\pgfmathresult}%
    \else
      \ifnum\amari@grid@max@A=0% 余り0の方
        % 座標の短縮
        \coordinate (P@amarizero) at (\mondai@position@tmp\width@KKran, -\mondai@position@y@tmp\width@KKran);
        \def\H{\shou@grid@max@A\unit@KKran}

        % 垂直線（左端除去）
        \foreach \x in {1,2,...,\grid@x@A} {
          \draw[dashed,line width=#2]
            ($(P@amarizero) + (\x\unit@KKran,0)$)
            -- ++(0,-\shou@grid@max@A\unit@KKran);
        }

        % 水平線
        \foreach \y in {0,1,...,\amari@grid@max@A} {
          \draw[dashed,line width=#2]
            ($(P@amarizero) + (0,-\y\unit@KKran)$)
            -- ++(\grid@x@A\unit@KKran,0);
        }

        \draw[line width=#2, dash pattern=on \mondai@dash@pat@on off \mondai@dash@pat@off] (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran) -- (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran-\shou@grid@max@A\unit@KKran);
        \draw[line width=#1]
          (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran-\shou@grid@max@A\unit@KKran) -- % 始点 A
          (\mondai@position@tmp\width@KKran+\grid@x@A\unit@KKran,-\mondai@position@y@tmp\width@KKran-\shou@grid@max@A\unit@KKran) -- % 終点 B
          (\mondai@position@tmp\width@KKran+\grid@x@A\unit@KKran,-\mondai@position@y@tmp\width@KKran) -- % 終点 C
          (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran); % 終点 D

      \else% 余り\neq0の方
        \coordinate (A@amari@non@zero) at (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran);%
        \coordinate (B@amari@non@zero) at (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran-\shou@grid@max@A\unit@KKran-\unit@KKran);%
        \coordinate (C@amari@non@zero) at (\mondai@position@tmp\width@KKran+\amari@grid@max@A\unit@KKran,-\mondai@position@y@tmp\width@KKran-\shou@grid@max@A\unit@KKran-\unit@KKran);%
        \coordinate (D@amari@non@zero) at (\mondai@position@tmp\width@KKran+\amari@grid@max@A\unit@KKran,-\mondai@position@y@tmp\width@KKran-\shou@grid@max@A\unit@KKran);%
        \coordinate (E@amari@non@zero) at (\mondai@position@tmp\width@KKran+\grid@x@A\unit@KKran,-\mondai@position@y@tmp\width@KKran-\shou@grid@max@A\unit@KKran);%
        \coordinate (F@amari@non@zero) at (\mondai@position@tmp\width@KKran+\grid@x@A\unit@KKran,-\mondai@position@y@tmp\width@KKran);%

        % 垂直線（左端除去）
        \foreach \x in {1,2,...,\amari@grid@max@A} {% 左ブロック
          \draw[dashed,line width=#2]
            ($(A@amari@non@zero) + (\x\unit@KKran,0)$)
            -- ++(0,-\shou@grid@max@A\unit@KKran-\unit@KKran);
        }
        \foreach \x in {1,2,...,\max@minus@amari@grid@max@A} {% 右ブロック
          \draw[dashed,line width=#2]
            ($(D@amari@non@zero) + (\x\unit@KKran,0)$)
            -- ++(0,\shou@grid@max@A\unit@KKran);
        }

        % 水平線
        \foreach \y in {0,1,...,\shou@grid@max@A} {% 左ブロック
          \draw[dashed,line width=#2]
            ($(A@amari@non@zero) + (0,-\y\unit@KKran)$)
            -- ++(\amari@grid@max@A\unit@KKran,0);
        }
        \foreach \y in {0,1,...,\shou@grid@max@A} {% 右ブロック
          \draw[dashed,line width=#2]
            ($(D@amari@non@zero) + (0,\y\unit@KKran)$)
            -- ++(\max@minus@amari@grid@max@A\unit@KKran,0);
        }

        \draw[line width=#2, dash pattern=on \mondai@dash@pat@on off \mondai@dash@pat@off] (A@amari@non@zero) -- (B@amari@non@zero);
        \draw[line width=#1] (B@amari@non@zero) -- (C@amari@non@zero)
        -- (D@amari@non@zero) -- (E@amari@non@zero) -- (F@amari@non@zero) -- (A@amari@non@zero);
      \fi
      \pgfmathparse{\mondai@position@tmp + \grid@x@A}%
      \edef\mondai@position@tmp{\pgfmathresult}%
    \fi
}

\NewDocumentCommand{\Shoumon@NonGrid@A}{ O{.7pt} O{.35pt} m}{% 第３引数はmax、第４引数はmin
    \def\nongrid@max@A{#3}%
    \def\nongrid@x@A{20}% 可変にしてもいい
    \pgfmathtruncatemacro{\shou@nongrid@max@A}{\nongrid@max@A / \nongrid@x@A}%
    \pgfmathtruncatemacro{\amari@nongrid@max@A}{mod(\nongrid@max@A,\nongrid@x@A)}%
    \pgfmathtruncatemacro{\max@minus@amari@nongrid@max@A}{\nongrid@x@A-\amari@nongrid@max@A}%

    \ifnum\nongrid@max@A<\nongrid@x@A% maxの方の描画のみ
      \draw[line width=#2, dash pattern=on \mondai@dash@pat@on off \mondai@dash@pat@off]  (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran) -- (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran-\unit@KKran);
      \draw[line width=#1]
        (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran-\unit@KKran) -- % 1. 底辺の始点 (左下の角)
        (\mondai@position@tmp\width@KKran+\amari@nongrid@max@A\unit@KKran,-\mondai@position@y@tmp\width@KKran-\unit@KKran) -- % 2. 底辺の終点 (右下の角)
        (\mondai@position@tmp\width@KKran+\amari@nongrid@max@A\unit@KKran,-\mondai@position@y@tmp\width@KKran+\shou@nongrid@max@A\unit@KKran) -- % 3. 右の縦の辺 (右上の角)
        (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran+\shou@nongrid@max@A\unit@KKran); % 4. 上辺の終点 (左上の角)

      \pgfmathparse{\mondai@position@tmp + \nongrid@max@A}%
      \edef\mondai@position@tmp{\pgfmathresult}%
    \else
      \ifnum\amari@nongrid@max@A=0% 余り0の方
        % 座標の短縮
        \coordinate (P@amarizero) at (\mondai@position@tmp\width@KKran, -\mondai@position@y@tmp\width@KKran);
        \def\H{\shou@nongrid@max@A\unit@KKran}

        % 水平線
        \foreach \y in {0,1,...,\amari@nongrid@max@A} {
          \draw[dashed,line width=#2]
            ($(P@amarizero) + (0,-\y\unit@KKran)$)
            -- ++(\nongrid@x@A\unit@KKran,0);
        }

        \draw[line width=#2, dash pattern=on \mondai@dash@pat@on off \mondai@dash@pat@off] (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran) -- (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran-\shou@nongrid@max@A\unit@KKran);
        \draw[line width=#1]
          (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran-\shou@nongrid@max@A\unit@KKran) -- % 始点 A
          (\mondai@position@tmp\width@KKran+\nongrid@x@A\unit@KKran,-\mondai@position@y@tmp\width@KKran-\shou@nongrid@max@A\unit@KKran) -- % 終点 B
          (\mondai@position@tmp\width@KKran+\nongrid@x@A\unit@KKran,-\mondai@position@y@tmp\width@KKran) -- % 終点 C
          (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran); % 終点 D

      \else% 余り\neq0の方
        \coordinate (A@amari@non@zero) at (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran);%
        \coordinate (B@amari@non@zero) at (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran-\shou@nongrid@max@A\unit@KKran-\unit@KKran);%
        \coordinate (C@amari@non@zero) at (\mondai@position@tmp\width@KKran+\amari@nongrid@max@A\unit@KKran,-\mondai@position@y@tmp\width@KKran-\shou@nongrid@max@A\unit@KKran-\unit@KKran);%
        \coordinate (D@amari@non@zero) at (\mondai@position@tmp\width@KKran+\amari@nongrid@max@A\unit@KKran,-\mondai@position@y@tmp\width@KKran-\shou@nongrid@max@A\unit@KKran);%
        \coordinate (E@amari@non@zero) at (\mondai@position@tmp\width@KKran+\nongrid@x@A\unit@KKran,-\mondai@position@y@tmp\width@KKran-\shou@nongrid@max@A\unit@KKran);%
        \coordinate (F@amari@non@zero) at (\mondai@position@tmp\width@KKran+\nongrid@x@A\unit@KKran,-\mondai@position@y@tmp\width@KKran);%

        % 水平線
        \foreach \y in {0,1,...,\shou@nongrid@max@A} {% 上ブロック
          \draw[dashed,line width=#2]
            ($(A@amari@non@zero) + (0,-\y\unit@KKran)$)
            -- ++(\nongrid@x@A\unit@KKran,0);
        }
        \draw[dashed,line width=#2]% 下ブロック
          ($(D@amari@non@zero) + (0,\shou@nongrid@max@A\unit@KKran)$)
          -- ++(\max@minus@amari@nongrid@max@A\unit@KKran,0);

        \draw[line width=#2, dash pattern=on \mondai@dash@pat@on off \mondai@dash@pat@off] (A@amari@non@zero) -- (B@amari@non@zero);
        \draw[line width=#1] (B@amari@non@zero) -- (C@amari@non@zero)
        -- (D@amari@non@zero) -- (E@amari@non@zero) -- (F@amari@non@zero) -- (A@amari@non@zero);
      \fi
      \pgfmathparse{\mondai@position@tmp + \nongrid@x@A}%
      \edef\mondai@position@tmp{\pgfmathresult}%
    \fi
}

\NewDocumentCommand{\GoDown}{m}{% 下へ行く
  \pgfmathparse{\mondai@position@y@tmp + #1}%
  \edef\mondai@position@y@tmp{\pgfmathresult}%
  \def\mondai@position@tmp{0}%
  \pgfmathparse{\mondai@position@tmp + \modai@bangou@wd}%
  \edef\mondai@position@tmp{\pgfmathresult}%
}

% 1.外枠と中身を黒塗り 2.中身を白抜き 3.本体の描画
\newcommand{\BlockFillMode@KKran}{%
  % 1. カウンターが進まないようにローカル化（または無効化）
  
  % 2. 各ボックス描画コマンドを「矩形塗りつぶし(\fill)」に再定義
  
  % \Daimon@Box@A@N のパッチ
  \RenewDocumentCommand{\Daimon@Box@A@N}{ O{.5} m }{%
    \global\def\modai@bangou@wd{##1}%
    \fill (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran) 
          rectangle ++(##1\width@KKran, -##2\width@KKran);%
    \pgfmathparse{\mondai@position@tmp + \modai@bangou@wd}%
    \edef\mondai@position@tmp{\pgfmathresult}%
  }%
  
  % Shoumon@Box@A@N のパッチ
  \RenewDocumentCommand{\Shoumon@Box@A@N}{ O{.5} m }{%
    \fill (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran) 
          rectangle ++(##1\width@KKran, -##2\width@KKran);%
    \pgfmathparse{\mondai@position@tmp + ##1}%
    \edef\mondai@position@tmp{\pgfmathresult}%
  }%
  
  % Shoumon@Box@A のパッチ
  \RenewDocumentCommand{\Shoumon@Box@A}{ O{.7pt} O{.35pt} m m O{} }{%
      \fill (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran) 
            rectangle ++(##3\width@KKran, -##4\width@KKran);%
      \pgfmathparse{\mondai@position@tmp + ##3}%
      \edef\mondai@position@tmp{\pgfmathresult}%
    }%
    \RenewDocumentCommand{\Shoumon@Box@B}{ O{.7pt} O{.35pt} m m O{} }{%
      \fill (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran) 
            rectangle ++(##3\width@KKran, -##4\width@KKran);%
      \pgfmathparse{\mondai@position@tmp + ##3}%
      \edef\mondai@position@tmp{\pgfmathresult}%
    }%

  % Shoumon@Grid@A/NonGrid@A
  \RenewDocumentCommand{\Shoumon@Grid@A}{ O{.7pt} O{.35pt} m O{##3}}{%
    % 必須: 元の座標計算ロジックを保持
    \def\grid@max@A{##3}\def\grid@min@A{##4}%
    \def\grid@x@A{20}% 可変にしてもいい
    \pgfmathtruncatemacro{\shou@grid@max@A}{\grid@max@A / \grid@x@A}%
    \pgfmathtruncatemacro{\amari@grid@max@A}{mod(\grid@max@A,\grid@x@A)}%
    \pgfmathtruncatemacro{\max@minus@amari@grid@max@A}{\grid@x@A-\amari@grid@max@A}%
    \pgfmathtruncatemacro{\shou@grid@min@A}{\grid@min@A / \grid@x@A}%
    \pgfmathtruncatemacro{\amari@grid@min@A}{mod(\grid@min@A,\grid@x@A)}%
    \pgfmathtruncatemacro{\min@minus@amari@grid@min@A}{\grid@x@A-\amari@grid@min@A}%
    
    \ifnum\grid@max@A<\grid@x@A
      \fill
      (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran-\unit@KKran) -- % 1. 底辺の始点 (左下の角)
      (\mondai@position@tmp\width@KKran+\amari@grid@max@A\unit@KKran,-\mondai@position@y@tmp\width@KKran-\unit@KKran) -- % 2. 底辺の終点 (右下の角)
      (\mondai@position@tmp\width@KKran+\amari@grid@max@A\unit@KKran,-\mondai@position@y@tmp\width@KKran+\shou@grid@max@A\unit@KKran) -- % 3. 右の縦の辺 (右上の角)
      (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran+\shou@grid@max@A\unit@KKran) -- cycle; % 4. 上辺の終点 (左上の角)
    \else
      \ifnum\amari@grid@max@A=0
        \fill
          (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran-\shou@grid@max@A\unit@KKran) -- % 始点 A
          (\mondai@position@tmp\width@KKran+\grid@x@A\unit@KKran,-\mondai@position@y@tmp\width@KKran-\shou@grid@max@A\unit@KKran) -- % 終点 B
          (\mondai@position@tmp\width@KKran+\grid@x@A\unit@KKran,-\mondai@position@y@tmp\width@KKran) -- % 終点 C
          (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran) -- cycle; % 終点 D
      \else
        \coordinate (A@amari@non@zero) at (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran);%
        \coordinate (B@amari@non@zero) at (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran-\shou@grid@max@A\unit@KKran-\unit@KKran);%
        \coordinate (C@amari@non@zero) at (\mondai@position@tmp\width@KKran+\amari@grid@max@A\unit@KKran,-\mondai@position@y@tmp\width@KKran-\shou@grid@max@A\unit@KKran-\unit@KKran);%
        \coordinate (D@amari@non@zero) at (\mondai@position@tmp\width@KKran+\amari@grid@max@A\unit@KKran,-\mondai@position@y@tmp\width@KKran-\shou@grid@max@A\unit@KKran);%
        \coordinate (E@amari@non@zero) at (\mondai@position@tmp\width@KKran+\grid@x@A\unit@KKran,-\mondai@position@y@tmp\width@KKran-\shou@grid@max@A\unit@KKran);%
        \coordinate (F@amari@non@zero) at (\mondai@position@tmp\width@KKran+\grid@x@A\unit@KKran,-\mondai@position@y@tmp\width@KKran);%
        \fill (B@amari@non@zero) -- (C@amari@non@zero)
        -- (D@amari@non@zero) -- (E@amari@non@zero) -- (F@amari@non@zero) -- (A@amari@non@zero) -- cycle;
      \fi
    \fi
  }
  \RenewDocumentCommand{\Shoumon@NonGrid@A}{ O{.7pt} O{.35pt} m O{##3}}{%
    % 必須: 元の座標計算ロジックを保持
    \def\nongrid@max@A{##3}\def\nongrid@min@A{##4}% <-- grid を nongrid に変更
    \def\nongrid@x@A{20}% 可変にしてもいい <-- grid を nongrid に変更
    \pgfmathtruncatemacro{\shou@nongrid@max@A}{\nongrid@max@A / \nongrid@x@A}% <-- grid を nongrid に変更
    \pgfmathtruncatemacro{\amari@nongrid@max@A}{mod(\nongrid@max@A,\nongrid@x@A)}% <-- grid を nongrid に変更
    \pgfmathtruncatemacro{\max@minus@amari@nongrid@max@A}{\nongrid@x@A-\amari@nongrid@max@A}% <-- grid を nongrid に変更
    \pgfmathtruncatemacro{\shou@nongrid@min@A}{\nongrid@min@A / \nongrid@x@A}% <-- grid を nongrid に変更
    \pgfmathtruncatemacro{\amari@nongrid@min@A}{mod(\nongrid@min@A,\nongrid@x@A)}% <-- grid を nongrid に変更
    \pgfmathtruncatemacro{\min@minus@amari@nongrid@min@A}{\nongrid@x@A-\amari@nongrid@min@A}% <-- grid を nongrid に変更
    
    \ifnum\nongrid@max@A<\nongrid@x@A
      \fill
      (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran-\unit@KKran) -- % 1. 底辺の始点 (左下の角)
      (\mondai@position@tmp\width@KKran+\amari@nongrid@max@A\unit@KKran,-\mondai@position@y@tmp\width@KKran-\unit@KKran) -- % 2. 底辺の終点 (右下の角)
      (\mondai@position@tmp\width@KKran+\amari@nongrid@max@A\unit@KKran,-\mondai@position@y@tmp\width@KKran+\shou@nongrid@max@A\unit@KKran) -- % 3. 右の縦の辺 (右上の角)
      (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran+\shou@nongrid@max@A\unit@KKran) -- cycle; % 4. 上辺の終点 (左上の角)
      
      % 必須: 座標更新ロジックの保持 (Case 1)
      \pgfmathparse{\mondai@position@tmp + \nongrid@max@A}%
      \edef\mondai@position@tmp{\pgfmathresult}%
    \else
      \ifnum\amari@nongrid@max@A=0
        \fill
          (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran-\shou@nongrid@max@A\unit@KKran) -- % 始点 A
          (\mondai@position@tmp\width@KKran+\nongrid@x@A\unit@KKran,-\mondai@position@y@tmp\width@KKran-\shou@nongrid@max@A\unit@KKran) -- % 終点 B
          (\mondai@position@tmp\width@KKran+\nongrid@x@A\unit@KKran,-\mondai@position@y@tmp\width@KKran) -- % 終点 C
          (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran) -- cycle; % 終点 D

        % 必須: 座標更新ロジックの保持 (Case 2)
        \pgfmathparse{\mondai@position@tmp + \nongrid@x@A}%
        \edef\mondai@position@tmp{\pgfmathresult}%
      \else
        \coordinate (A@amari@non@zero) at (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran);%
        \coordinate (B@amari@non@zero) at (\mondai@position@tmp\width@KKran,-\mondai@position@y@tmp\width@KKran-\shou@nongrid@max@A\unit@KKran-\unit@KKran);%
        \coordinate (C@amari@non@zero) at (\mondai@position@tmp\width@KKran+\amari@nongrid@max@A\unit@KKran,-\mondai@position@y@tmp\width@KKran-\shou@nongrid@max@A\unit@KKran-\unit@KKran);%
        \coordinate (D@amari@non@zero) at (\mondai@position@tmp\width@KKran+\amari@nongrid@max@A\unit@KKran,-\mondai@position@y@tmp\width@KKran-\shou@nongrid@max@A\unit@KKran);%
        \coordinate (E@amari@non@zero) at (\mondai@position@tmp\width@KKran+\nongrid@x@A\unit@KKran,-\mondai@position@y@tmp\width@KKran-\shou@nongrid@max@A\unit@KKran);%
        \coordinate (F@amari@non@zero) at (\mondai@position@tmp\width@KKran+\nongrid@x@A\unit@KKran,-\mondai@position@y@tmp\width@KKran);%
        \fill (B@amari@non@zero) -- (C@amari@non@zero)
        -- (D@amari@non@zero) -- (E@amari@non@zero) -- (F@amari@non@zero) -- (A@amari@non@zero) -- cycle;

        % 必須: 座標更新ロジックの保持 (Case 3)
        \pgfmathparse{\mondai@position@tmp + \nongrid@x@A}%
        \edef\mondai@position@tmp{\pgfmathresult}%
      \fi
    \fi
  }
}

\NewDocumentCommand{\KKran}{ O{2pt} m }{%
  % 描画内容をマクロとして定義（３回使い回す）
  \def\byouga@KKran{%
    #2
  }
  \begin{tikzpicture}
    % 1. 黒の太線シルエット（背景）
    %    BlockFillModeでコマンドを「塗りつぶし」に変え、カウンターをリセットしてから描画
    \begin{scope}[line width=#1, line join=round] 
      \BlockFillMode@KKran
      % fillだけでなくdrawも行うことで外側に太らせる
      \tikzset{every path/.style={draw=black, fill=black}} 
      \byouga@KKran
    \end{scope}

    % 2. 白のシルエット（中抜き用）
    %    線の太さを0にして、純粋な形状だけで黒い塊の内側をくり抜く
    \begin{scope}
      \BlockFillMode@KKran
      \tikzset{every path/.style={fill=white, draw=none}}
      \byouga@KKran
    \end{scope}

    % 3. 本番の描画（前面）
    \begin{scope}
      \byouga@KKran
    \end{scope}
  \end{tikzpicture}
}

\endinput